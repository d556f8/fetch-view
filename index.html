<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>storyview-template</title>
  <link rel="stylesheet" href="./assets/css/main.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <style>
    .storyview-content-item > .storyview-content-item-wrapper > img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }

  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

  <script>
    // root에 storyview-component를 렌더링해준다.
    document.getElementById('root').innerHTML = `
      <storyview-component></storyview-component>
    `;
    
    class StoryView extends HTMLElement {
      constructor() {
        super();
        
        // StoryView의 data이다.
        // story의 정보를 담는 배열이다.
        this.data = [];
    
        // StoryView의 template이다.
        this.innerHTML = `
          <div class="storyview">
            <div class="storyview-header">
              <div class="storyview-content">
                <ul class="storyview-content-list">
                  <!-- TODO: <li class="storyview-content-item"></li> -->
                </ul>
              </div>
            </div>
          </div>
          <button class="view-fetch-btn">Fetch</button>
          <button class="new-data-btn">New Data</button>
        `;
        
        // storyview-content-list는 각 스토리를 표현해줄 수 있는 요소이다.
        this.storyviewContentList = this.querySelector('.storyview-content-list');

        // viewFetch는 fetch를 통해 데이터를 가져오는 버튼이다.
        this.viewFetch = this.querySelector('.view-fetch-btn');
        this.viewFetch.addEventListener('click', async () => await this.initData());

        // newDataBtn은 새로운 데이터를 추가하는 버튼이다.
        // 여기서는 테스트용으로 임시로 데이터를 추가해주었다.
        this.newDataBtn = this.querySelector('.new-data-btn');
        this.newDataBtn.addEventListener('click', async () => await this.postNewData({
          title: 'new title',
          content: 'new content',
          image: 'https://picsum.photos/200/300',
        }));
      }
      
      // story를 표현해주는 template이다.
      // id, title, content, image를 받아서 template을 반환한다.
      storyviewContentItemTemplate({ id, title, content, image }) {
        const template = `
          <li class="storyview-content-item">
            <div class="storyview-content-item-wrapper">
              <h1>${title}</h1>
              <p>${content}</p>
              <img src="${image}" />
            </div>
          </li>
        `;
        return template;
      }

      async postNewData({title, content, image}) {
        const res = await fetch('http://localhost:7000/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({title, content, image}),
        });

        if (res.ok) {
          console.log(res.status);
        } else {
          console.error(res.status);
        }
      }
    
      async initData() {
        const res = await fetch('http://localhost:7000/posts');
        this.data = await res.json();
    
        this.render();
      }
      
      // 해당 StoryView가 DOM에 추가되었을 때 실행되는 함수이다.
      async connectedCallback() {
        await this.initData();
        this.render();
      }
      
      render() {
        // data를 통해 storyview-content-list를 렌더링해준다.
        this.storyviewContentList.innerHTML = '';
        this.data.forEach((item) => {
          this.storyviewContentList.innerHTML +=
            this.storyviewContentItemTemplate(item);
        });
      }
    }
    
    window.customElements.define('storyview-component', StoryView); 
  </script>
</body>
</html>